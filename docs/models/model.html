<!DOCTYPE html><html lang="en"><head><title>models/model</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="models/model"><meta name="groc-project-path" content="app/models/model.coffee"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/models/model.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="model">Model</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="vi">@Models = </span><span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span> <span class="s">&#39;models&#39;</span>
<span class="vi">@ModelObjects = </span><span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span> <span class="s">&#39;modelObjects&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="model-action">Model Action</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="vi">@ModelActions = </span><span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">Collection</span> <span class="s">&#39;modelActions&#39;</span>

<span class="nv">ModelActionConstructors = </span><span class="p">{}</span>
<span class="nv">ModelObjectTypes = </span><span class="p">[</span>
  <span class="s">&#39;voxel&#39;</span>
<span class="p">]</span>

<span class="nv">getModelActionToUndo = </span><span class="nf">(modelId) -&gt;</span>
  <span class="nv">model = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="nx">modelId</span>
  <span class="nv">actionId = </span><span class="nx">model</span><span class="o">?</span><span class="p">.</span><span class="nx">actionIds</span><span class="o">?</span><span class="p">.</span><span class="nx">undo</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">actionId</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="nx">ModelActions</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="nx">actionId</span>

<span class="nv">getModelActionToRedo = </span><span class="nf">(modelId) -&gt;</span>
  <span class="nv">model = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="nx">modelId</span>
  <span class="nv">actionId = </span><span class="nx">model</span><span class="o">?</span><span class="p">.</span><span class="nx">actionIds</span><span class="o">?</span><span class="p">.</span><span class="nx">redo</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">actionId</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="nx">ModelActions</span><span class="p">.</span><span class="nx">findOne</span> <span class="nx">actionId</span>

<span class="nv">setModelActionIds = </span><span class="nf">(options) -&gt;</span>
  <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span> <span class="p">{</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">modelId</span><span class="p">},</span>
    <span class="nv">$set:</span>
      <span class="nv">actionIds:</span>
        <span class="nv">undo: </span><span class="nx">options</span><span class="p">.</span><span class="nx">undoActionId</span>
        <span class="nv">redo: </span><span class="nx">options</span><span class="p">.</span><span class="nx">redoActionId</span>

<span class="k">class</span> <span class="nx">ModelAction</span>
  <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
    <span class="nx">@validateBasicOptions</span> <span class="nx">options</span>
    <span class="nx">@validateSpecifics</span> <span class="nx">options</span>

    <span class="vi">@modelId = </span><span class="nx">options</span><span class="p">.</span><span class="nx">modelId</span>
    <span class="vi">@doneAt = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
    <span class="vi">@type = </span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span>
    <span class="vi">@specifics = </span><span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span>
    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span>
      <span class="vi">@_id = </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span>
    <span class="k">else</span>
      <span class="nx">@save</span><span class="p">()</span>

  <span class="nv">validateBasicOptions: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No options passed to model action!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">modelId</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No model ID (options.modelId) passed to model action!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span> <span class="nx">options</span><span class="p">.</span><span class="nx">modelId</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Model ID &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">modelId</span> <span class="o">+</span> <span class="s">&#39;, passed to model action, does not exist!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No type (options.type) passed to model action!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">ModelActionConstructors</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Type &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s">&#39;, passed to model action, does not exist!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No specifics (options.specifics) passed to model action!&#39;</span>

  <span class="nv">validateSpecifics: </span><span class="nf">(specifics) -&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;ModelAction.validateSpecifics() not implemented!&#39;</span>

  <span class="nv">do: </span><span class="nf">-&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;ModelAction.do() not implemented!&#39;</span>

  <span class="nv">undo: </span><span class="nf">-&gt;</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;ModelAction.undo() not implemented!&#39;</span>

  <span class="nv">getDatabaseObject: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="k">this</span>

  <span class="nv">save: </span><span class="nf">-&gt;</span>
    <span class="nv">databaseObject = </span><span class="nx">@getDatabaseObject</span><span class="p">()</span>
    <span class="nv">actionToUndo = </span><span class="nx">getModelActionToUndo</span> <span class="nx">@modelId</span>
    <span class="nv">actionToRedo = </span><span class="nx">getModelActionToRedo</span> <span class="nx">@modelId</span>

    <span class="k">if</span> <span class="nx">actionToRedo</span>
      <span class="nv">actionToDelete = </span><span class="nx">actionToRedo</span>
      <span class="k">while</span> <span class="nx">actionToDelete</span>
        <span class="nx">ModelActions</span><span class="p">.</span><span class="nx">remove</span> <span class="nv">_id: </span><span class="nx">actionToDelete</span><span class="p">.</span><span class="nx">_id</span>
        <span class="k">if</span> <span class="nx">actionToDelete</span><span class="p">.</span><span class="nx">nextActionId</span>
          <span class="nv">actionToDelete = </span><span class="nx">ModelActions</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="nx">actionToDelete</span><span class="p">.</span><span class="nx">nextActionId</span>
        <span class="k">else</span>
          <span class="nv">actionToDelete = </span><span class="kc">null</span>

    <span class="k">if</span> <span class="nx">actionToUndo</span>
      <span class="nv">databaseObject.previousActionId = </span><span class="nx">actionToUndo</span><span class="p">.</span><span class="nx">_id</span>
      <span class="vi">@_id = </span><span class="nx">ModelActions</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">databaseObject</span>
      <span class="nx">ModelActions</span><span class="p">.</span><span class="nx">update</span> <span class="p">{</span><span class="nv">_id: </span><span class="nx">actionToUndo</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="p">{</span><span class="nv">$set: </span><span class="p">{</span><span class="nv">nextActionId: </span><span class="nx">@_id</span><span class="p">}}</span>
    <span class="k">else</span>
      <span class="vi">@_id = </span><span class="nx">ModelActions</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">databaseObject</span>

  <span class="nv">update: </span><span class="nf">(updateOptions) -&gt;</span>
    <span class="nx">ModelActions</span><span class="p">.</span><span class="nx">update</span> <span class="p">{</span><span class="nv">_id: </span><span class="nx">@_id</span><span class="p">},</span> <span class="nx">updateOptions</span>

<span class="k">class</span> <span class="nx">ModelActionAddObject</span> <span class="k">extends</span> <span class="nx">ModelAction</span>
  <span class="nv">validateSpecifics: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No object passed to specifics (options.specifics.object) of model action addObject!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No type passed to specifics object (options.specifics.object.type) of model action addObject!&#39;</span>
    <span class="k">if</span> <span class="nx">ModelObjectTypes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Invalid type &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s">&#39; passed to specifics object (options.specifics.object.type) of model action addObject. Valid object types are: &#39;</span> <span class="o">+</span> <span class="nx">ModelObjectTypes</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No position passed to specifics object (options.specifics.object.position) of model action addObject!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No x value passed to specifics object\&#39;s position (options.specifics.object.position.x) of model action addObject!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No y value passed to specifics object\&#39;s position (options.specifics.object.position.y) of model action addObject!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No z value passed to specifics object\&#39;s position (options.specifics.object.position.z) of model action addObject!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">color</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No color passed to specifics object (options.specifics.object.color) of model action addObject!&#39;</span>
    <span class="nv">colorAsInteger = </span><span class="nb">parseInt</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="mi">16</span>
    <span class="k">if</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">colorAsInteger</span><span class="p">)</span> <span class="o">or</span> <span class="nx">colorAsInteger</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">colorAsInteger</span> <span class="o">&gt;</span> <span class="mi">16777215</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Invalid color passed to specifics object (options.specifics.object.color) of model action addObject. Valid color values are hexadecimal strings from 000000 to FFFFFF.&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Specifics for type 'voxel':
* size</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s">&#39;voxel&#39;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">size</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No size passed to specifics object for type voxel (options.specifics.object.size) of model action addObject!&#39;</span>
      <span class="nv">validSize = </span><span class="kc">false</span>
      <span class="k">for</span> <span class="nx">voxelSize</span> <span class="k">in</span> <span class="nx">DefaultVoxelSizes</span>
        <span class="k">if</span> <span class="nx">voxelSize</span><span class="p">.</span><span class="nx">size</span> <span class="o">==</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">size</span>
          <span class="nv">validSize = </span><span class="kc">true</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">validSize</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Invalid voxel size &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">size</span> <span class="o">+</span> <span class="s">&#39; passed to specifics object for type voxel (options.specifics.object.size) of model action addObject!&#39;</span>
    <span class="nv">options.specifics.object.modelId = </span><span class="nx">options</span><span class="p">.</span><span class="nx">modelId</span>
  <span class="nv">do: </span><span class="nf">-&gt;</span>
    <span class="k">if</span> <span class="nx">@specifics</span><span class="p">.</span><span class="nx">objectId</span>
      <span class="vi">@specifics.object._id = </span><span class="nx">@specifics</span><span class="p">.</span><span class="nx">objectId</span>
      <span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">@specifics</span><span class="p">.</span><span class="nx">object</span>
    <span class="k">else</span>
      <span class="vi">@specifics.objectId = </span><span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">@specifics</span><span class="p">.</span><span class="nx">object</span>
      <span class="nx">@update</span> <span class="nv">$set: </span><span class="s">&#39;specifics.objectId&#39;</span><span class="o">:</span> <span class="nx">@specifics</span><span class="p">.</span><span class="nx">objectId</span>
  <span class="nv">undo: </span><span class="nf">-&gt;</span>
    <span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">remove</span> <span class="nv">_id: </span><span class="nx">@specifics</span><span class="p">.</span><span class="nx">objectId</span>

<span class="nv">ModelActionConstructors.addObject = </span><span class="nx">ModelActionAddObject</span>

<span class="k">class</span> <span class="nx">ModelActionRemoveObject</span> <span class="k">extends</span> <span class="nx">ModelAction</span>
  <span class="nv">validateSpecifics: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">objectId</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;No object id passed to specifics (options.specifics.objectId) of model action removeObject!&#39;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span>
      <span class="nv">options.specifics.object = </span><span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">findOne</span> <span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">objectId</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">object</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Invalid object id &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">specifics</span><span class="p">.</span><span class="nx">objectId</span> <span class="o">+</span> <span class="s">&#39; passed to specifics (options.specifics.objectId) of model action removeObject!&#39;</span>
  <span class="nv">do: </span><span class="nf">-&gt;</span>
    <span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">remove</span> <span class="nv">_id: </span><span class="nx">@specifics</span><span class="p">.</span><span class="nx">objectId</span>
  <span class="nv">undo: </span><span class="nf">-&gt;</span>
    <span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">@specifics</span><span class="p">.</span><span class="nx">object</span>

<span class="nv">ModelActionConstructors.removeObject = </span><span class="nx">ModelActionRemoveObject</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="methods">Methods</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nx">Meteor</span><span class="p">.</span><span class="nx">methods</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="do-model-action">Do model action</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">doModelAction: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">modelId</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">collaborator</span>
      <span class="nv">ActionConstructor = </span><span class="nx">ModelActionConstructors</span><span class="p">[</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">ActionConstructor</span>
        <span class="nv">action = </span><span class="k">new</span> <span class="nx">ActionConstructor</span> <span class="nx">options</span>
        <span class="nx">action</span><span class="p">.</span><span class="nx">do</span><span class="p">()</span>
        <span class="nx">setModelActionIds</span>
          <span class="nv">modelId: </span><span class="nx">action</span><span class="p">.</span><span class="nx">modelId</span>
          <span class="nv">undoActionId: </span><span class="nx">action</span><span class="p">.</span><span class="nx">_id</span>
          <span class="nv">redoActionId: </span><span class="kc">null</span>
    <span class="k">else</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;Model action &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s">&#39; does not exist!&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="undo-model-action">Undo model action</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">undoModelAction: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">modelId</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="nv">actionObject = </span><span class="nx">getModelActionToUndo</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">modelId</span>
      <span class="k">if</span> <span class="nx">actionObject</span>
        <span class="nv">ActionConstructor = </span><span class="nx">ModelActionConstructors</span><span class="p">[</span><span class="nx">actionObject</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">ActionConstructor</span>
          <span class="nv">action = </span><span class="k">new</span> <span class="nx">ActionConstructor</span> <span class="nx">actionObject</span>
          <span class="nx">action</span><span class="p">.</span><span class="nx">undo</span><span class="p">()</span>
          <span class="nv">previousActionId = </span><span class="nx">actionObject</span><span class="p">.</span><span class="nx">previousActionId</span> <span class="o">?</span> <span class="kc">null</span>
          <span class="nx">setModelActionIds</span>
            <span class="nv">modelId: </span><span class="nx">action</span><span class="p">.</span><span class="nx">modelId</span>
            <span class="nv">undoActionId: </span><span class="nx">previousActionId</span>
            <span class="nv">redoActionId: </span><span class="nx">action</span><span class="p">.</span><span class="nx">_id</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="redo-model-action">Redo model action</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">redoModelAction: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">modelId</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="nv">actionObject = </span><span class="nx">getModelActionToRedo</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">modelId</span>
      <span class="k">if</span> <span class="nx">actionObject</span>
        <span class="nv">ActionConstructor = </span><span class="nx">ModelActionConstructors</span><span class="p">[</span><span class="nx">actionObject</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">ActionConstructor</span>
          <span class="nv">action = </span><span class="k">new</span> <span class="nx">ActionConstructor</span> <span class="nx">actionObject</span>
          <span class="nx">action</span><span class="p">.</span><span class="nx">do</span><span class="p">()</span>
          <span class="nv">nextActionId = </span><span class="nx">actionObject</span><span class="p">.</span><span class="nx">nextActionId</span> <span class="o">?</span> <span class="kc">null</span>
          <span class="nx">setModelActionIds</span>
            <span class="nv">modelId: </span><span class="nx">action</span><span class="p">.</span><span class="nx">modelId</span>
            <span class="nv">undoActionId: </span><span class="nx">action</span><span class="p">.</span><span class="nx">_id</span>
            <span class="nv">redoActionId: </span><span class="nx">nextActionId</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="create-model">Create model</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">createModel: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">currentProfile</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="s">&quot;You need to be logged in to create a Model&quot;</span><span class="p">)</span>
      
    <span class="nv">checkNameAvailability = </span><span class="nx">findModelByName</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span>
    <span class="k">if</span> <span class="nx">checkNameAvailability</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="s">&quot;Modelname already taken&quot;</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">creator</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">predecessor</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">isPublic</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="s">&quot;Paramters not defined&quot;</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nv">modelId = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nv">name: </span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="nv">createdAt: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span><span class="nx">updatedAt</span><span class="o">:</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span><span class="nx">tags</span><span class="o">:</span><span class="p">[],</span><span class="nx">creator</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">creator</span><span class="p">,</span><span class="nx">invited</span><span class="o">:</span><span class="p">[],</span><span class="nx">predecessor</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">predecessor</span><span class="p">,</span><span class="nx">isPublic</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">isPublic</span><span class="p">,</span><span class="nx">colors</span><span class="o">:</span><span class="nx">DefaultModelColors</span><span class="p">})</span>
      <span class="nx">Profiles</span><span class="p">.</span><span class="nx">update</span> <span class="p">{</span><span class="nv">_id: </span><span class="nx">currentProfile</span><span class="p">().</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$push: </span><span class="p">{</span><span class="nv">favourites: </span><span class="nx">modelId</span><span class="p">}}</span>
      <span class="k">return</span> <span class="nx">modelId</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="clone-model">Clone model</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">cloneModel: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">predecessor</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">viewer</span>
      <span class="nv">checkNameAvailability = </span><span class="nx">findModelByName</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span>
      <span class="k">if</span> <span class="nx">checkNameAvailability</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="s">&quot;Modelname already taken&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="nv">predecessorModel = </span><span class="nx">findOneModelByOptions</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">predecessor</span><span class="p">})</span>
        <span class="nv">modelId = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nv">name: </span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="nv">createdAt: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span><span class="nx">updatedAt</span><span class="o">:</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span><span class="nx">tags</span><span class="o">:</span><span class="p">[],</span><span class="nx">creator</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">creator</span><span class="p">,</span><span class="nx">invited</span><span class="o">:</span><span class="p">[],</span><span class="nx">predecessor</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">predecessor</span><span class="p">,</span><span class="nx">isPublic</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">isPublic</span><span class="p">,</span><span class="nx">colors</span><span class="o">:</span><span class="nx">predecessorModel</span><span class="p">.</span><span class="nx">colors</span><span class="p">})</span>
        <span class="nv">predecessorModelObjects = </span><span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nx">modelId</span><span class="o">:</span><span class="nx">options</span><span class="p">.</span><span class="nx">predecessor</span><span class="p">}).</span><span class="nx">fetch</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">predecessorModelObject</span> <span class="k">in</span> <span class="nx">predecessorModelObjects</span>
          <span class="k">delete</span> <span class="nx">predecessorModelObject</span><span class="p">.</span><span class="nx">_id</span>
          <span class="nv">predecessorModelObject.modelId = </span><span class="nx">modelId</span>
          <span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">insert</span> <span class="nx">predecessorModelObject</span>
        <span class="nx">Profiles</span><span class="p">.</span><span class="nx">update</span> <span class="p">{</span><span class="nv">_id: </span><span class="nx">currentProfile</span><span class="p">().</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$push: </span><span class="p">{</span><span class="nv">favourites: </span><span class="nx">modelId</span><span class="p">}}</span>
        <span class="k">return</span> <span class="nx">modelId</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update-model-name">Update model name</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">updateModelName: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="nv">checkNameAvailability = </span><span class="nx">findModelByName</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span>
      <span class="nv">optionsFind = </span><span class="p">{</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">}</span>
      <span class="nv">currentModel = </span><span class="nx">findOneModelByOptions</span><span class="p">(</span><span class="nx">optionsFind</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">checkNameAvailability</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">currentModel</span><span class="p">.</span><span class="nx">name</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">499</span><span class="p">,</span> <span class="s">&quot;Modelname already taken&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$set: </span><span class="p">{</span><span class="nv">name: </span><span class="nx">options</span><span class="p">.</span><span class="nx">name</span><span class="p">}})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update-models-public-state">Update model's public state</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">updateModelIsPublic: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="nv">isPublic = </span><span class="nx">options</span><span class="p">.</span><span class="nx">isPublic</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">isPublic</span> <span class="o">==</span> <span class="kc">false</span>
        <span class="nv">isPublic = </span><span class="kc">true</span>
      <span class="k">else</span>
        <span class="nv">isPublic = </span><span class="kc">false</span>
      <span class="k">return</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$set: </span><span class="p">{</span><span class="nv">isPublic: </span><span class="nx">isPublic</span><span class="p">}})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update-model-tag">Update model tag</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">updateModelTag: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">collaborator</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tag</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="s">&quot;Undefined Parameter&quot;</span><span class="p">);</span>
      <span class="nv">tagName = </span><span class="nx">options</span><span class="p">.</span><span class="nx">tag</span>
      <span class="nv">checkForAvailability = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nv">tags: </span><span class="nx">tagName</span><span class="p">})</span>
      <span class="k">if</span> <span class="nx">tagName</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">497</span><span class="p">,</span> <span class="s">&quot;Tagname too short&quot;</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">checkForAvailability</span> <span class="o">!=</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">498</span><span class="p">,</span> <span class="s">&quot;Tagname already added&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$push: </span><span class="p">{</span><span class="nv">tags: </span><span class="nx">tagName</span><span class="p">}})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="update-model-invite">Update model invite</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">updateModelInvite: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">invite</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="s">&quot;Undefined Parameter&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">invite</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">497</span><span class="p">,</span> <span class="s">&quot;Username too short&quot;</span><span class="p">);</span>
      <span class="nv">invitedProfile = </span><span class="nx">Profiles</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">name: </span><span class="nx">options</span><span class="p">.</span><span class="nx">invite</span><span class="p">})</span>

      <span class="k">if</span> <span class="nx">invitedProfile</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">496</span><span class="p">,</span> <span class="s">&quot;Username does not exist&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="nv">checkAlreadyInvited = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span><span class="s">&#39;invited.userId&#39;</span><span class="o">:</span><span class="nx">invitedProfile</span><span class="p">.</span><span class="nx">_id</span><span class="p">})</span>
      <span class="k">if</span> <span class="nx">checkAlreadyInvited</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="nv">updateObject = </span><span class="p">{</span><span class="nv">userId: </span><span class="nx">invitedProfile</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nv">role: </span><span class="nx">options</span><span class="p">.</span><span class="nx">role</span><span class="p">}</span>
        <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$push: </span><span class="p">{</span><span class="nv">invited: </span><span class="nx">updateObject</span><span class="p">}})</span>        
      <span class="k">else</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">498</span><span class="p">,</span> <span class="s">&quot;User already invited&quot;</span><span class="p">)</span>   </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-model-tag">Remove model tag</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">removeModelTag: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">collaborator</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tag</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="s">&quot;Undefined Parameter&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$pull: </span><span class="p">{</span><span class="nv">tags: </span><span class="nx">options</span><span class="p">.</span><span class="nx">tag</span><span class="p">}})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-model-invite">Remove model invite</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">removeModelInvite: </span><span class="nf">(options) -&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">invite</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="s">&quot;Undefined Parameter&quot;</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="nv">profile = </span><span class="nx">findOneProfileByOptions</span><span class="p">({</span><span class="nv">name: </span><span class="nx">options</span><span class="p">.</span><span class="nx">invite</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">profile</span> <span class="o">==</span> <span class="kc">undefined</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">496</span><span class="p">,</span> <span class="s">&quot;Username does not exist&quot;</span><span class="p">);</span>
        <span class="k">else</span>
          <span class="nv">removeObject = </span><span class="p">{</span><span class="nx">invited</span><span class="o">:</span><span class="p">{</span><span class="nx">userId</span><span class="o">:</span><span class="nx">profile</span><span class="p">.</span><span class="nx">_id</span><span class="p">}}</span>
          <span class="k">return</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nv">_id: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span><span class="p">},{</span><span class="nv">$pull: </span><span class="nx">removeObject</span><span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="remove-model">Remove model</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">removeModel: </span><span class="nf">(options)-&gt;</span>
    <span class="k">if</span> <span class="nx">userHasAtLeastRole</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">_id</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">invite</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span><span class="p">(</span><span class="mi">490</span><span class="p">,</span> <span class="s">&quot;Undefined Parameter&quot;</span><span class="p">);</span>
      <span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">remove</span> <span class="nv">modelId: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span>
      <span class="nx">ModelActions</span><span class="p">.</span><span class="nx">remove</span> <span class="nv">modelId: </span><span class="nx">options</span><span class="p">.</span><span class="nx">_id</span>
      <span class="nx">Models</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">options</span>

<span class="vi">@modelLoaded = </span><span class="nf">-&gt;</span>
  <span class="nv">model = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({})</span>
  <span class="k">if</span> <span class="nx">model</span> <span class="o">==</span> <span class="kc">undefined</span>
    <span class="k">return</span> <span class="kc">false</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="kc">true</span>

<span class="vi">@findModelByName = </span><span class="nf">(name)-&gt;</span>
  <span class="k">return</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nv">name: </span><span class="nx">name</span><span class="p">})</span>

<span class="vi">@findOneModelByOptions = </span><span class="nf">(options) -&gt;</span>
  <span class="k">return</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gets the Modelid and a boolean (if isPublic should be used) as parameter
Returns the Users Role for the specified Model</p></div></div><div class="code"><div class="wrapper"><span class="vi">@checkModelPermission = </span><span class="nf">(modelId, useIsPublic) -&gt;</span>
  <span class="nv">options = </span><span class="p">{</span><span class="nv">_id: </span><span class="nx">modelId</span><span class="p">}</span>
  <span class="nv">model = </span><span class="nx">findOneModelByOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">model</span> <span class="o">==</span> <span class="kc">undefined</span>
    <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">none</span>

  <span class="k">if</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nx">userId</span><span class="p">()</span> <span class="o">==</span> <span class="kc">null</span>
    <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isPublic</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">useIsPublic</span> <span class="o">==</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">viewer</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">none</span>

  <span class="nv">isCreator = </span><span class="nx">findOneModelByOptions</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span><span class="nx">modelId</span><span class="p">,</span><span class="nv">creator: </span><span class="nx">currentProfile</span><span class="p">().</span><span class="nx">_id</span><span class="p">})</span>
  <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">invited</span> <span class="o">!=</span> <span class="kc">undefined</span>
    <span class="nv">isInvited = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">invitation</span> <span class="k">in</span> <span class="nx">model</span><span class="p">.</span><span class="nx">invited</span>
      <span class="k">if</span> <span class="nx">invitation</span><span class="p">.</span><span class="nx">userId</span> <span class="o">==</span> <span class="nx">currentProfile</span><span class="p">().</span><span class="nx">_id</span>
        <span class="nx">isInvited</span><span class="p">.</span><span class="nx">push</span> <span class="nx">invitation</span>
    <span class="k">if</span> <span class="nx">isInvited</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">isInvited</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">role</span> <span class="o">==</span> <span class="s">&quot;owner&quot;</span>
        <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">owner</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">isInvited</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">role</span> <span class="o">==</span> <span class="s">&quot;collaborator&quot;</span>
        <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">collaborator</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">isInvited</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">role</span> <span class="o">==</span> <span class="s">&quot;viewer&quot;</span>
        <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">viewer</span>
  <span class="k">if</span> <span class="nx">isCreator</span>
    <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">creator</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">isPublic</span> <span class="o">==</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">useIsPublic</span> <span class="o">==</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">viewer</span>
    <span class="k">else</span>
      <span class="k">return</span> <span class="nx">Roles</span><span class="p">.</span><span class="nx">none</span>

<span class="vi">@userHasAtLeastRole = </span><span class="nf">(modelId, role) -&gt;</span>
  <span class="nv">modelPermission = </span><span class="nx">checkModelPermission</span> <span class="nx">modelId</span><span class="p">,</span> <span class="kc">true</span>
  <span class="nv">mayDoAction = </span><span class="nx">modelPermission</span> <span class="o">&gt;=</span> <span class="nx">role</span>
  <span class="k">if</span> <span class="nx">mayDoAction</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nx">Meteor</span><span class="p">.</span><span class="nb">Error</span> <span class="mi">490</span><span class="p">,</span> <span class="s">&#39;You don\&#39;t have the permission to do this operation!&#39;</span>

<span class="vi">@Roles =</span>
  <span class="nv">none: </span><span class="mi">0</span><span class="p">,</span>
  <span class="nv">viewer: </span><span class="mi">1</span><span class="p">,</span>
  <span class="nv">collaborator: </span><span class="mi">2</span><span class="p">,</span>
  <span class="nv">owner: </span><span class="mi">3</span><span class="p">,</span>
  <span class="nv">creator: </span><span class="mi">4</span>

<span class="vi">@DefaultModelColors = </span><span class="p">[</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;FF0000&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;1&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;FF00D9&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;2&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;2600FF&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;3&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">3</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;00E1FF&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;4&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">4</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;00FF2F&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;5&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;EAFF00&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;6&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">6</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;FFCC99&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;7&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">7</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;FF3C00&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;8&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">8</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;ffffff&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;9&quot;</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">9</span><span class="p">,</span> <span class="nv">color: </span><span class="s">&quot;000000&quot;</span><span class="p">,</span> <span class="nv">shortcut: </span><span class="s">&quot;0&quot;</span><span class="p">}</span>
<span class="p">]</span>

<span class="vi">@DefaultVoxelSizes = </span><span class="p">[</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">name: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">1</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">name: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">2</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">2</span><span class="p">,</span> <span class="nv">name: </span><span class="mi">3</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">4</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">3</span><span class="p">,</span> <span class="nv">name: </span><span class="mi">4</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">8</span><span class="p">}</span>
  <span class="p">{</span><span class="nv">index: </span><span class="mi">4</span><span class="p">,</span> <span class="nv">name: </span><span class="mi">5</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">16</span><span class="p">}</span>
<span class="p">]</span></div></div></div></div></body></html>