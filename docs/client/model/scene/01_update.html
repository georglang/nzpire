<!DOCTYPE html><html lang="en"><head><title>client/model/scene/01_update</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="client/model/scene/01_update"><meta name="groc-project-path" content="app/client/model/scene/01_update.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/client/model/scene/01_update.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="update">Update</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nx">@Modeling</span> <span class="o">?=</span> <span class="p">{}</span>
<span class="nx">Modeling</span><span class="p">.</span><span class="nx">scene</span> <span class="o">?=</span> <span class="p">{}</span>
<span class="nv">scene = </span><span class="nx">Modeling</span><span class="p">.</span><span class="nx">scene</span>

<span class="nv">cubeMaterial = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshLambertMaterial</span> <span class="nv">color: </span><span class="mh">0x7FAD00</span>

<span class="nv">scene.update = </span><span class="o">-&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="parallelization-of-update-process">Parallelization of update process</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">parallelizationContext =</span>
    <span class="nv">latestDBObjects: </span><span class="nx">ModelObjects</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="nv">modelId: </span><span class="nx">Session</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;modelId&#39;</span><span class="p">}).</span><span class="nx">fetch</span><span class="p">()</span>
    <span class="nv">currentSceneObjects: </span><span class="nx">Modeling</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">currentObjects</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;# curr objects&#39;</span><span class="p">,</span> <span class="nx">parallelizationContext</span><span class="p">.</span><span class="nx">currentSceneObjects</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;# db   objects&#39;</span><span class="p">,</span> <span class="nx">parallelizationContext</span><span class="p">.</span><span class="nx">latestDBObjects</span><span class="p">.</span><span class="nx">length</span>

  <span class="nv">parallelSceneUpdater = </span><span class="k">new</span> <span class="nx">Parallel</span> <span class="nx">parallelizationContext</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="identify-changes">Identify changes</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">parallelSceneUpdater</span><span class="p">.</span><span class="nx">spawn</span> <span class="nf">(context) -&gt;</span>
    <span class="nv">currentSceneObjects = </span><span class="nx">context</span><span class="p">.</span><span class="nx">currentSceneObjects</span>
    <span class="nv">objectsToBeAdded = </span><span class="p">[]</span>
    <span class="nv">objectsToBeUpdated = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">objectDB</span> <span class="k">in</span> <span class="nx">context</span><span class="p">.</span><span class="nx">latestDBObjects</span>
      <span class="nv">objectCurrentlyInScene = </span><span class="nx">context</span><span class="p">.</span><span class="nx">currentSceneObjects</span><span class="p">[</span><span class="nx">objectDB</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">objectCurrentlyInScene</span>
        <span class="nx">objectsToBeAdded</span><span class="p">.</span><span class="nx">push</span> <span class="nx">objectDB</span>
        <span class="nx">currentSceneObjects</span><span class="p">[</span><span class="nx">objectDB</span><span class="p">.</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">objectDB</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="todo">TODO</h4>

<p>Register all objects that were updated according to field 'updatedAt'</p></div></div><div class="code"><div class="wrapper">    <span class="nv">updateData =</span>
      <span class="nv">currentSceneObjects: </span><span class="nx">currentSceneObjects</span>
      <span class="nv">objectsToBeAdded: </span><span class="nx">objectsToBeAdded</span>
      <span class="nv">objectsToBeUpdated: </span><span class="nx">objectsToBeUpdated</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="incorporate-changes-into-the-scene">Incorporate changes into the scene</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">parallelSceneUpdater</span><span class="p">.</span><span class="k">then</span> <span class="nf">(updateData) -&gt;</span>
    <span class="nv">Modeling.scene.currentObjects = </span><span class="nx">updateData</span><span class="p">.</span><span class="nx">currentSceneObjects</span>
    <span class="k">for</span> <span class="nx">newObject</span> <span class="k">in</span> <span class="nx">updateData</span><span class="p">.</span><span class="nx">objectsToBeAdded</span>
      <span class="nv">cubeMesh = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CubeGeometry</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="nx">cubeMaterial</span><span class="p">)</span>
      <span class="nv">cubeMesh.position = </span><span class="nx">newObject</span><span class="p">.</span><span class="nx">position</span>
      <span class="nx">Modeling</span><span class="p">.</span><span class="nx">scene</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">add</span> <span class="nx">cubeMesh</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h4 id="todo">TODO</h4>

<p>Incorporate all object updates</p></div></div></div></div></body></html>